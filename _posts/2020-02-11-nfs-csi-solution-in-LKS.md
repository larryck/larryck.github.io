---
title: nfs csi solution in LKS
description: 
categories:
- k8s
- storage
tags:
- policy
---

# Problem
How we support nfs-csi in LKS?

# Solution
To some degree, file system based csi solution shows advantages to block based solution, for example large scale persistent volume scenarios and multiple R/W bind use cases. 

As for LKS, we choose cinder-csi storageclass as the default storage solution of Kubernetes clusters, mainly because it's the only storage service we can leverage from the IaaS platform. After we met the block number limitation problem, we decided to build nfs-csi service for LKS.

## rook
We find rook from CNCF community and know that it's a project to ease the burden of adopting different storage systems on Kubernetes. More importantly, rook supports nfs, though not stably.

The nfs solution of rook is very easy to understand, mainly consists of two parts: a crd to handle the life-cycle of nfs server and a provisioner service to implement csi provisioning mechanism. Rook request a pvc for each nfs server which can host the data persistently. 

But there is a issue of rook which really puzzles me, since we find that all PVs generated by the nfs storageclass of rook share the same directory on nfs server. We believe this will bring in risks for all applications using this storageclass.

## Kubernetes external nfs storage
Thus, we study the external nfs storage of kubernetes community, which is good because it separates directoies for each persistent volume. The only problem we need to solve is that it's only a nfs client solution. It does not cover nfs server service. 

Cloud we combine the nfs server service from rook project and the nfs client interface from the external nfs storage project of Kubernetes? How do we meet the data high availability requirement?

## LKS nfs storage service
This is exactly what we do in lksnfs-csi service. For nfs server, we build it from rook nfs operator. We modify rook nfs operator and use PVs provided by the default cinder-csi service as the nfs backend data pools. Data high-availiblity is ensured by the underlying ceph SDS system of cinder storage service. As for the nfs csi part, we configure the Kubernetes external nfs client service to bind the nfs server generated by rook. Thus we also get the benifits of different root directory for each PV and data archive after PV deletion.

We build nfs storage service as a managed plugin(plugin service is a frastructure service of LKS to extend its capability to meet more user scenarios. It follows the helm/charts standards.) in LKS, users can install it whenever they need. LKS is responsible for the stability and performance of the nfs servcie.
